#!/usr/bin/env bash

dmenu_color(){
    dmen -i -l 10 -p "$1"
}

clipboard_duration=15

new="generate new password"
delete="remove secret"
change="change length and don't use symbols"
set_username="edit secret"

chosen=$(printf "%s\n""$new""\n""$delete""\n""$change""\n""$set_username" "$(gopass ls -f | grep -E '^(ol|ht)')" | dmenu_color "Secret or Action: " | awk '{print $1}')
[ -z "$chosen" ] && exit

if [ "$chosen" == "generate" ]; then
    folder="$(printf %s "$(gopass ls --fo)" | dmenu_color "Which folder?" | awk '{print $1}')"
    [ -z "$folder" ] && exit
    name=$(</dev/null dmenu_color "Which name?" | awk '{print $1}')
    [ -z "$name" ] && exit
    gopass --yes generate -s "$folder"/"$name" 24 && notify-send "New password in ""$folder"/"$name"" copied to clipboard."
    exit

elif [ "$chosen" == "remove" ]; then
    rm_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?" | awk '{print $1}')
    [ -z "$rm_file" ] && exit
    gopass --yes rm "$rm_file" && notify-send "$rm_file"" removed!"
    exit

elif [ "$chosen" == "change" ]; then
    change_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?" | awk '{print $1}')
    [ -z "$change_file" ] && exit
    length=$(</dev/null dmenu_color "Which length?" | awk '{print $1}')
    [ -z "$length" ] && exit
    re='^[0-9]+$'
    if ! [[ "$length" =~ $re ]] ; then
        notify-send "ERROR: Length must be a number!" && exit 1
    fi
    gopass --yes generate "$change_file" "$length" && notify-send "New password with length <b>""$length""</b> copied to clipboard."
    exit

elif [ "$chosen" == "edit" ]; then
    username_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?" | awk '{print $1}')
    [ -z "$username_file" ] && exit
    "$TERMINAL" -e gopass edit "$username_file"
    wait
    exit
fi

secret="$(gopass show "$chosen")"
[ -z "$secret" ] && exit

password="$(echo "$secret" | grep -vE "^username: .*$")"
[ -z "$password" ] && exit

username="$(echo "$secret" | grep -E "^username: .*$" | awk '{print $2}')"

paste_username_and_password_in_brave() { #only works with vimium plugin
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$username""$(echo $'\u001B')"gi"$(echo $'\u0009')"
    paste_password
}

paste_username_and_password () {
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$username""$(echo $'\u0009')"
    paste_password
}

paste_password() {
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$password"
    # "$(echo $'\u000D')"
}

id=$(xdotool getactivewindow)
if [ "$username" ]; then
    xprop -id "$id" | grep -Ei "brave" && paste_username_and_password_in_brave
    xprop -id "$id" | grep -Ei "firefox" && paste_username_and_password
else
    xprop -id "$id" | grep -Ei "(firefox|chromium|skype|brave)" && paste_password
fi

echo "$password" | xclip -selection c

notify-send "Secret in '""$chosen""' copied to clipboard. Will clear in ""$clipboard_duration"" seconds."

sleep "$clipboard_duration"

echo "" | xclip -selection c
notify-send "Clipboard cleared!"
