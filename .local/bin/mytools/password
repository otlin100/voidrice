#!/bin/bash

dmenu_color(){
    dmen -i -l 10 -p "$1"
}

clipboard_duration=15

new="generate new password"
delete="remove secret"
change="change length and don't use symbols"
set_username="edit secret"

chosen=$(printf "%s\n""$new""\n""$delete""\n""$change""\n""$set_username" "$(gopass ls -f)" | dmenu_color "Secret or Action: ")

[ -z "$chosen" ] && exit

case "$chosen" in
    generate*)
        folder="$(printf %s "$(gopass ls -d)" | dmenu_color "Which folder?")"
        [ -z "$folder" ] && exit
        name=$(</dev/null dmenu_color "Which name?")
        [ -z "$name" ] && exit
        gopass generate -s -c -f "$folder"/"$name" 24 && notify-send "New password in ""$folder"/"$name"" copied to clipboard."
        exit ;;
    remove*)
        rm_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?")
        [ -z "$rm_file" ] && exit
        gopass rm -f "$rm_file" && notify-send "$rm_file"" removed!"
        exit ;;
    change*)
        change_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?")
        [ -z "$change_file" ] && exit
        length=$(</dev/null dmenu_color "Which length?")
        [ -z "$length" ] && exit
        re='^[0-9]+$'
        if ! [[ "$length" =~ $re ]] ; then
            notify-send "ERROR: Length must be a number!" && exit 1
        fi
        gopass generate -f -c "$change_file" "$length" && notify-send "New password with length <b>""$length""</b> copied to clipboard."
        exit ;;
    edit*)
        username_file=$(printf %s "$(gopass ls -f)" | dmenu_color "Which secret?")
        [ -z "$username_file" ] && exit
        "$TERMINAL" -e gopass edit "$username_file"
        wait
        exit ;;
esac

password=$(gopass show -o "$chosen")
[ -z "$password" ] && exit

username=$(gopass show "$chosen" | grep -E "^username: .*$" | awk '{print $2}')

paste_username_and_password_in_brave() { #only works with vimium plugin
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$username""$(echo $'\u001B')"gi"$(echo $'\u0009')"
    paste_password
}

paste_username_and_password () {
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$username""$(echo $'\u0009')"
    paste_password
}

paste_password() {
    xdotool key ctrl+a
    xdotool type --delay 0 --clearmodifiers --window "$id" "$password"
    # "$(echo $'\u000D')"
}

id=$(xdotool getactivewindow)
if [ "$username" ]; then
    xprop -id "$id" | grep -Ei "brave" && paste_username_and_password_in_brave
    xprop -id "$id" | grep -Ei "firefox" && paste_username_and_password
else
    xprop -id "$id" | grep -Ei "(firefox|chromium|skype|brave)" && paste_password
fi

echo "$password" | xclip -selection c

notify-send "Secret in '""$chosen""' copied to clipboard. Will clear in ""$clipboard_duration"" seconds."

sleep "$clipboard_duration"

echo "" | xclip -selection c
notify-send "Clipboard cleared!"
