#!/bin/sh

devices="$XDG_CONFIG_HOME/bluetooth/devices"
[ -r "$devices" ] || { notify-send -u critical "file '$devices' does not exist"; exit; }
selected_dmenu=$(cut -d'|' -f2 "$devices" | dmen -l 10 -p "connect to which device?")
selected=$(grep "$selected_dmenu" "$devices" | cut -d'|' -f1)
bt_string=$(systemctl is-active bluetooth)

case "$selected_dmenu" in
    '') break ;;
    disconnect) [ "$bt_string" = "active" ] && echo "power off" | bluetoothctl ;;
    toggle) toggle_bluetooth ;;
    new_device) $TERMINAL "$EDITOR" "$devices" ;;
    blueman)
        pkill -f blueman
        [ "$bt_string" = "inactive" ] && toggle_bluetooth
        blueman-manager &
        blueman-applet &
        sleep 1
        pkill -f blueman-tray ;;
    *)
        [ -z "$selected" ] && break
        [ "$bt_string" = "inactive" ] && toggle_bluetooth
        sleep 2
        echo "power on" | bluetoothctl
        sleep 1
        echo  "connect $selected" | bluetoothctl
        sleep 4
        device=$(echo "info" | bluetoothctl | grep -i name | cut -d':' -f2)
        { [ -z "$device" ] && notify-send -t 15000 -u critical "failed to connect"; } ||
            notify-send "connected:$device" ;;
    esac

pkill -RTMIN+15 dwmblocks
